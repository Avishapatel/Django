{% extends 'index.html' %}

{% block content %}

<!-- Navbar Start -->
    <div class="container-fluid mb-4">
        <div class="row border-top px-xl-5">
            <div class="col-lg-3 d-none d-lg-block">
                <a class="btn shadow-none d-flex align-items-center justify-content-between bg-primary text-white w-100" data-toggle="collapse" href="#navbar-vertical" style="height: 65px; margin-top: -1px; padding: 0 30px;">
                    <h6 class="m-0">Categories</h6>
                    <i class="fa fa-angle-down text-dark"></i>
                </a>
                
                <nav class="collapse position-absolute navbar navbar-vertical navbar-light align-items-start p-0 border bg-white shadow" id="navbar-vertical" style="width: calc(100% - 30px); z-index: 9999; height: 530px; overflow-y: auto;">

                <!-- <nav class="collapse position-absolute navbar navbar-vertical navbar-light align-items-start p-0 border border-top-0 border-bottom-0 bg-white" id="navbar-vertical" style="width: calc(100% - 30px); z-index: 1;"> -->
                    <div class="navbar-nav w-100 overflow-hidden" style="height: 530px">
                        {% for i in c_id %}
                        <div class="nav-item dropdown">
                            <a href="#" class="nav-link" data-toggle="dropdown">{{ i.cat_name }} <i class="fa fa-angle-down float-right mt-1"></i></a>
                            <div class="dropdown-menu position-absolute bg-secondary border-0 rounded-0 w-100 m-0">
                                {% for sub in i.sub_category_set.all %}
                                    <a href="{% url 'shop' %}?s_id={{ sub.id }}" class="dropdown-item">{{ sub.sbcat_name }}</a>
                                {% empty %}
                                    <span class="dropdown-item disabled">No subcategories</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                       
                    </div>
                </nav>
                
            </div>
            <div class="col-lg-9">
                <nav class="navbar navbar-expand-lg bg-light navbar-light py-3 py-lg-0 px-0">
                    <a href="" class="text-decoration-none d-block d-lg-none">
                        <h1 class="m-0 display-5 font-weight-semi-bold"><span class="text-primary font-weight-bold border px-3 mr-1">E</span>Shopper</h1>
                    </a>
                    <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse justify-content-between" id="navbarCollapse">
                        <div class="navbar-nav mr-auto py-0">
                            <a href="{% url 'index' %}" class="nav-item nav-link">Home</a>
                            <a href="{% url 'shop' %}" class="nav-item nav-link">Shop</a>
                            <a href="{% url 'detail' %}" class="nav-item nav-link">Shop Detail</a>
                            <div class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Pages</a>
                                <div class="dropdown-menu rounded-0 m-0">
                                    <a href="{% url 'cart' %}" class="dropdown-item">Shopping Cart</a>
                                    <a href="{% url 'checkout' %}" class="dropdown-item">Checkout</a>
                                    <a href="{% url 'wishlist' %}"class="dropdown-item">Wishlist</a>
                                </div>
                            </div>
                            <a href="{% url 'contact' %}" class="nav-item nav-link">Contact</a>
                        </div>
                        <div class="navbar-nav ml-auto py-0">
                            {% if request.session.user_name %}
                                <a href="{% url 'profile' %}" class="nav-item nav-link active">Hi, {{ request.session.user_name }}</a>
                                <a href="{% url 'logout' %}" class="nav-item nav-link">Logout</a>  <!-- <-- use logout URL -->
                            {% else %}
                                <a href="{% url 'login' %}" class="nav-item nav-link">Login</a>
                                <a href="{% url 'register' %}" class="nav-item nav-link">Register</a>
                            {% endif %}
                        </div>
                    </div>
                </nav>
{% if messages %}
<div class="container mt-3">
    {% for message in messages %}
        {% if 'logout' in message.tags %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <script>
                setTimeout(function() {
                    $('.alert').fadeOut('slow', function() { $(this).remove(); });
                }, 3000);  <!-- auto-dismiss after 3 seconds -->
            </script>
        {% endif %}
    {% endfor %}
</div>
{% endif %}


            </div> 
        </div>
    </div>
    <!-- Navbar End -->


<!-- Page Header Start -->
<div class="container-fluid bg-secondary">
  <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 200px">
    <h2 class="font-weight-semi-bold text-uppercase mb-3">My Profile</h2>
    <div class="d-inline-flex">
      <p class="m-0"><a href="{% url 'index' %}">Home</a></p>
      <p class="m-0 px-2">-</p>
      <p class="m-0">My Profile</p>
    </div>
  </div>
</div>
<!-- Page Header End -->


<style>
/* page-scoped profile image + camera button */
.profile-pic-wrapper { position: relative; width:140px; height:140px; margin:0 auto; }
.profile-pic-wrapper .profile-image-preview {
  width:100%; height:100%; object-fit:cover; border-radius:50%; display:block;
  border:2px solid #fff; box-shadow:0 2px 6px rgba(0,0,0,0.15);
}
.profile-pic-wrapper .camera-btn {
  position: absolute;
  right: -4px;
  bottom: -4px;
  width:38px;
  height:38px;
  border-radius:50%;
  background:#ffffff;
  border:1px solid rgba(0,0,0,0.1);
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 2px 6px rgba(0,0,0,0.12);
  cursor:pointer;
}
.profile-pic-wrapper .camera-btn i { color:#555; font-size:16px; }
</style>




<div class="container-fluid pt-5">
  
  <div class="row px-xl-5 justify-content-center">
    <style>
/* inline (page-scoped) placeholder override */
.placeholder-inline::placeholder { color: rgb(179, 176, 176); font-size: 15px; opacity: 1; }
.placeholder-inline::-webkit-input-placeholder { color: rgb(179, 176, 176); font-size: 15px }
.placeholder-inline:-ms-input-placeholder { color: rgb(179, 176, 176); font-size: 15px }
.placeholder-inline::-ms-input-placeholder { color: rgb(179, 176, 176); font-size: 15px }
</style>


    <div class="col-lg-9">
      <div class="row">
        
        <div class="col-md-4 mb-5">
          
          <div class="card shadow-sm">
            
            <div class="card-body text-center">
              
                <div class="profile-pic-wrapper">
               <img src="{% if user_name.user_img %}{{ user_name.user_img.url }}{% else %}/static/img/user_img.jpg{% endif %}"
       class="profile-image-preview"
       alt="User">
       <form id="profile-image-form" method="post" action="{% url 'upload_profile_image' %}" enctype="multipart/form-data" style="margin-top:8px;">
    {% csrf_token %}
    
    <input type="file" name="user_img" id="profile-image-input" accept="image/*" style="display:none;">
    <button type="button" id="change-image-btn" class="camera-btn"><i class="fa-solid fa-camera"></i></button>
  </form>
  </div>
              <h5 class="font-weight-semi-bold mt-3">{{ user_name }}</h5>
            </div>
            <ul class="list-group list-group-flush">
              <li class="list-group-item">Cart items: {{ cart_id.count }}</li>
              <li class="list-group-item">Wishlist items: {{ wishlist_id.count }}</li>
              <li class="list-group-item">Orders: {{ orders.count|default:0 }}</li>
            </ul>
          </div>
        </div>

        <div class="col-md-8 mb-5">
          <h4 class="mb-3">Account Details</h4>

            {% if alert %}
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        {{ alert }}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    {% endif %}

                    {% if messages %}
                    {% for message in messages %}
                        {% if 'update_profile_subscribe' in message.tags %}
                        <div class="alert 
                            {% if 'success' in message.tags %}alert-success
                            {% elif 'error' in message.tags %}alert-danger
                            {% endif %}
                            auto-hide-message">
                            {{ message }}
                        </div>
                        {% endif %}
                    {% endfor %}
                    {% endif %}

          <form action="{% url 'update_profile' %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="source" value="update_profile_subscribe">
            <div class="form-group">
              <label>Name</label>
              <input type="text" name="full_name" class="form-control form-control-lg" value="{{ user_name }}" required>
            </div>

            <div class="form-group">
              <label>Phone</label>
              <input type="text" name="phone_no" class="form-control form-control-lg" value="{{user_name.phone_no}}">
            </div>
           
        <p class="text-right" id="changePasswordLink">
    <a href="javascript:void(0);" onclick="showChangePassword()">Change password?</a>
</p>
 <!-- Hidden field (ye value views.py me jayegi) -->
    <input type="hidden" name="action_type" id="action_type" value="update_profile">

<div id="changePasswordSection" style="display: none;">

    <div class="form-group">
        <input type="password" name="old_password"
               class="form-control form-control-lg placeholder-inline"
               placeholder="Old Password">
    </div>

    <div class="form-group">
        <input type="password" name="new_password"
               class="form-control form-control-lg placeholder-inline"
               placeholder="New Password">
    </div>

    <div class="form-group">
        <input type="password" name="confirm_password"
               class="form-control form-control-lg placeholder-inline"
               placeholder="Confirm Password">
    </div>
</div>


<button type="submit" class="btn btn-primary btn-block border-0 py-3">Update Profile</button>

</form>

<!-- upload image script -->
<script>
document.getElementById('change-image-btn').addEventListener('click', function () {
  document.getElementById('profile-image-input').click();
});
document.getElementById('profile-image-input').addEventListener('change', function () {
  if (this.files && this.files[0]) {
    var file = this.files[0];
    if (!file.type.startsWith('image/')) { alert('Please select an image file.'); this.value = ''; return; }
    var reader = new FileReader();
    reader.onload = function (e) { document.querySelector('.profile-image-preview').src = e.target.result; };
    reader.readAsDataURL(file);
    document.getElementById('profile-image-form').submit();
  }
});
</script>

<!-- change password script -->
<script>
function showChangePassword() {
    document.getElementById('changePasswordSection').style.display = 'block';
    document.getElementById('changePasswordLink').style.display = 'none';
    document.getElementById('action_type').value = "change_password";
}
</script>

          <hr class="my-4">

         
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
  <!-- Footer Start -->
    <div class="container-fluid bg-secondary text-dark mt-5 pt-5">
        <div class="row px-xl-5 pt-5">
            <div class="col-lg-4 col-md-12 mb-5 pr-3 pr-xl-5">
                <a href="" class="text-decoration-none">
                    <h1 class="mb-4 display-5 font-weight-semi-bold"><span class="text-primary font-weight-bold border border-white px-3 mr-1">E</span>Shopper</h1>
                </a>
                <p>This online shopping platform offers quality products at affordable prices with a smooth and secure shopping experience.</p>
                <p class="mb-2"><i class="fa fa-map-marker-alt text-primary mr-3"></i>Surat ,Gujarat ,India</p>
                <p class="mb-2"><i class="fa fa-envelope text-primary mr-3"></i>avisha14898@gmail.com</p>
                <p class="mb-0"><i class="fa fa-phone-alt text-primary mr-3"></i>6351241596</p>
            </div>
            <div class="col-lg-8 col-md-12">
                <div class="row">
                    <div class="col-md-4 mb-5">
                        <h5 class="font-weight-bold text-dark mb-4">Quick Links</h5>
                        <div class="d-flex flex-column justify-content-start">
                            <a class="text-dark mb-2" href="{% url 'index' %}"><i class="fa fa-angle-right mr-2"></i>Home</a>
                            <a class="text-dark mb-2" href="{% url 'shop' %}"><i class="fa fa-angle-right mr-2"></i>Our Shop</a>
                            <a class="text-dark mb-2" href="{% url 'detail' %}"><i class="fa fa-angle-right mr-2"></i>Shop Detail</a>
                            <a class="text-dark mb-2" href="{% url 'cart' %}"><i class="fa fa-angle-right mr-2"></i>Shopping Cart</a>
                            <a class="text-dark mb-2" href="{% url 'checkout' %}"><i class="fa fa-angle-right mr-2"></i>Checkout</a>
                            <a class="text-dark" href="{% url 'contact' %}"><i class="fa fa-angle-right mr-2"></i>Contact Us</a>
                        </div>
                    </div>
                    <div class="col-md-4 mb-5">
                        <h5 class="font-weight-bold text-dark mb-4">Quick Links</h5>
                        <div class="d-flex flex-column justify-content-start">
                            <a class="text-dark mb-2" href="{% url 'index' %}"><i class="fa fa-angle-right mr-2"></i>Home</a>
                            <a class="text-dark mb-2" href="{% url 'shop' %}"><i class="fa fa-angle-right mr-2"></i>Our Shop</a>
                            <a class="text-dark mb-2" href="{% url 'detail' %}"><i class="fa fa-angle-right mr-2"></i>Shop Detail</a>
                            <a class="text-dark mb-2" href="{% url 'cart' %}"><i class="fa fa-angle-right mr-2"></i>Shopping Cart</a>
                            <a class="text-dark mb-2" href="{% url 'checkout' %}"><i class="fa fa-angle-right mr-2"></i>Checkout</a>
                            <a class="text-dark" href="{% url 'contact' %}"><i class="fa fa-angle-right mr-2"></i>Contact Us</a>
                        </div>
                    </div>
                    <div class="col-md-4 mb-5">
                        <h5 class="font-weight-bold text-dark mb-4">Newsletter</h5>
                        {% if subscriber %}
                        <form action="{% url 'unsubscribe' %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="source" value="footer_subscribe">
                            <div class="form-group">
                                <input type="text" class="form-control border-0 py-4" placeholder="Your Name" value="{{user_name.full_name}}" name="name" readonly />
                            </div>
                            <div class="form-group">
                                <input type="email" class="form-control border-0 py-4" placeholder="Your Email" value="{{user_name.email_id}}" name="email"
                                   readonly />
                            </div>
                            <div>
                                <button class="btn btn-primary btn-block border-0 py-3" type="submit">Unsubscribe</button>
                            </div>
                        </form>
                        {% else %}
                        <form action="{% url 'subscribe' %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="source" value="footer_subscribe">

                            <div class="form-group">
                                <input type="text" class="form-control border-0 py-4" placeholder="Your Name" value="{{user_name.full_name}}" name="name" required />
                            </div>
                            <div class="form-group">
                                <input type="email" class="form-control border-0 py-4" placeholder="Your Email" value="{{user_name.email_id}}" name="email"
                                   readonly />
                            </div>
                            <div>
                                <button class="btn btn-primary btn-block border-0 py-3" type="submit">Subscribe Now</button>
                            </div>
                        </form>
                      {% endif %}
                       
                   
                    </div>
                </div>
                
                    {% if messages %}
                    {% for message in messages %}
                        {% if 'footer_subscribe' in message.tags %}
                        <div class="alert 
                            {% if 'success' in message.tags %}alert-success
                            {% elif 'error' in message.tags %}alert-danger
                            {% endif %}
                            auto-hide-message">
                            {{ message }}
                        </div>
                        {% endif %}
                    {% endfor %}
                    {% endif %}

                    <script>
                        setTimeout(function () {
                            const alerts = document.querySelectorAll('.auto-hide-message');
                            alerts.forEach(function(alert) {
                            alert.style.opacity = '0';
                            setTimeout(() => alert.remove(), 500);
                            });
                        }, 3000);
                        </script>


                    
            </div>
        </div>
        <div class="row border-top border-light mx-xl-5 py-4">
            <div class="col-md-6 px-xl-0">
                <p class="mb-md-0 text-center text-md-left text-dark">
                    &copy; <a class="text-dark font-weight-semi-bold" href="#">Shopping Platform</a>. All Rights Reserved. Designed
                    by
                    <a class="text-dark font-weight-semi-bold" href="https://htmlcodex.com">HTML Codex</a><br>
                    Distributed By <a href="https://themewagon.com" target="_blank">ThemeWagon</a>
                </p>
            </div>
            <div class="col-md-6 px-xl-0 text-center text-md-right">
                <img class="img-fluid" src="static/img/payments.png" alt="">
            </div>
        </div>
    </div>
    <!-- Footer End -->


    <!-- Back to Top -->
    <a href="#" class="btn btn-primary back-to-top"><i class="fa fa-angle-double-up"></i></a>


    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>

    <!-- Contact Javascript File -->
    <script src="mail/jqBootstrapValidation.min.js"></script>
    <script src="mail/contact.js"></script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script>
</body>

</html>